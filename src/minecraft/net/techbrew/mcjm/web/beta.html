<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>JourneyMap: Beta</title>
</head>
<style>
	html,body{height:100%;margin:0;padding:0;font-family:Tahoma;font-size:10px}
	#map-canvas{height:100%}
</style>
<body>

    <div id="map-canvas"></div>

    <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false"></script>
    <script type="text/javascript">
    /* <![CDATA[ */

        var JM = JM || {};
        JM.ImagesBaseUrl = '/map.png';
        
        // EuclideanProjection class
        //////////////////////////////////
        function EuclideanProjection() {
            var EUCLIDEAN_RANGE = 256;
            this.pixelOrigin_ = new google.maps.Point(EUCLIDEAN_RANGE / 2, EUCLIDEAN_RANGE / 2);
            this.pixelsPerLonDegree_ = EUCLIDEAN_RANGE / 360;
            this.pixelsPerLonRadian_ = EUCLIDEAN_RANGE / (2 * Math.PI);
            this.scaleLat = 18; // Height
            this.scaleLng = 18; // Width
            this.offsetLat = 0; // Height
            this.offsetLng = 0; // Width
        };
         
        EuclideanProjection.prototype.fromLatLngToPoint = function(latLng, opt_point) {
            var point = opt_point || new google.maps.Point(0, 0);
            var origin = this.pixelOrigin_;
            point.x = (origin.x + (latLng.lng() + this.offsetLng ) * this.scaleLng * this.pixelsPerLonDegree_);
            // NOTE(appleton): Truncating to 0.9999 effectively limits latitude to
            // 89.189.  This is about a third of a tile past the edge of the world tile.
            point.y = (origin.y + (-1 * latLng.lat() + this.offsetLat ) * this.scaleLat * this.pixelsPerLonDegree_);
            return point;
        };
         
        EuclideanProjection.prototype.fromPointToLatLng = function(point) {
            var me = this;
            var origin = me.pixelOrigin_;
            var lng = (((point.x - origin.x) / me.pixelsPerLonDegree_) / this.scaleLng) - this.offsetLng;
            var lat = ((-1 *( point.y - origin.y) / me.pixelsPerLonDegree_) / this.scaleLat) - this.offsetLat;
            return new google.maps.LatLng(lat, lng, true);
        };

        // RegionMap class
        //////////////////////////////////
        JM.RegionMap = function (container) {
            // Create map
            this._map = new google.maps.Map(container, {
                zoom: 0,
                center: new google.maps.LatLng(12,36),
                mapTypeControl: false,
                streetViewControl: false
            });

            // Set custom tiles
            this._map.mapTypes.set('region', new JM.ImgMapType());
            this._map.setMapTypeId('region');
        };


        // ImgMapType class
        //////////////////////////////////
        JM.ImgMapType = function () {
        };

        JM.ImgMapType.prototype.projection = new EuclideanProjection();
        JM.ImgMapType.prototype.tileSize = new google.maps.Size(512,512);
        JM.ImgMapType.prototype.minZoom = 0;
        JM.ImgMapType.prototype.maxZoom = 5;

        JM.ImgMapType.prototype.getTile = function (coord, zoom, ownerDocument) {

        	var SIZE = 512;
            var img = ownerDocument.createElement('IMG');
            img.width = SIZE;
            img.height = SIZE;
            
            var CHUNKS = Math.pow(2,5-zoom);
            var minX = coord.x * CHUNKS;
            var minZ = coord.y * CHUNKS;
            var maxX = minX + CHUNKS;
            var maxZ = minZ + CHUNKS;
            
            var mapType = "night";
            var dimension = 0;
            var depth = 4;
            var request = "?mapType=" + mapType + "&dimension=" + dimension + "&depth=" + depth + "&x1=" + minX + "&z1=" + minZ + "&x2="
                    + maxX + "&z2=" + maxZ + "&width=" + SIZE + "&height=" + SIZE;
            
            console.log("getTile: " + coord.x + "," + coord.y + " / zoom: " + zoom + ": " + request);
                  
            img.src = JM.Utils.GetImageUrl(request);                        

            return img;
        };

        // ZoomButtonControl class
        //////////////////////////////////
        JM.ZoomButtonControl = function (container, map, level) {
            var button = document.createElement('IMG');
            button.style.cursor = 'pointer';
            button.src = JM.Utils.GetImageUrl(level > 0 ? 'plus.png' : 'minus.png');
            container.appendChild(button);

            google.maps.event.addDomListener(button, 'click', function () {
                map.setZoom(map.getZoom() + level);
            });
        };

        // ImageControl class
        //////////////////////////////////
        JM.ImageControl = function (image, container, map, callback) {
            var button = document.createElement('IMG');
            button.style.cursor = 'pointer';
            button.style.display = 'block';
            button.src = JM.Utils.GetImageUrl(image);
            container.appendChild(button);

            google.maps.event.addDomListener(button, 'click', function () {
                callback();
            });
        };

        // ZoomLevelsControl class
        //////////////////////////////////
        JM.ZoomLevelsControl = function (container, map) {
            this._container = container;
            this._map = map;

            this._buildUI();
            this._updateUI();
            this._bindZoomEvent();
        };

        JM.ZoomLevelsControl.prototype._buildUI = function () {
            var currentMapType = this._map.mapTypes.get(this._map.getMapTypeId());

            for (var i = currentMapType.maxZoom; i >= currentMapType.minZoom; i--) {
                var level = document.createElement('IMG');
                level.style.cursor = 'pointer';
                if (i != currentMapType.minZoom) level.style.marginBottom = '2px';
                level.style.display = 'block';
                level.src = JM.Utils.GetImageUrl('level.png');
                this._bindLevelClick(level, i);
                this._container.appendChild(level);
            }
        };

        JM.ZoomLevelsControl.prototype._updateUI = function () {
            var currentMapType = this._map.mapTypes.get(this._map.getMapTypeId());
            var currentZoom = this._map.getZoom();
            var levelsCount = currentMapType.maxZoom - currentMapType.minZoom;

            for (var i = 0; i < levelsCount; i++)
            JM.Utils.SetOpacity(this._container.childNodes[i], (currentMapType.maxZoom - i) <= currentZoom ? 100 : 30);
        };

        JM.ZoomLevelsControl.prototype._bindZoomEvent = function () {
            var self = this;

            google.maps.event.addListener(this._map, 'zoom_changed', function () {
                self._updateUI();
            });
        };

        JM.ZoomLevelsControl.prototype._bindLevelClick = function (bar, zoom) {
            var self = this;

            google.maps.event.addDomListener(bar, 'click', function () {
                self._map.setZoom(zoom);
            });
        };

        // TextWindow class
        //////////////////////////////////
        JM.TextWindow = function (map) {
            this._map = map;
            this._window = null;
            this._text = null;
            this._position = null;
        };

        JM.TextWindow.prototype = new google.maps.OverlayView();

        JM.TextWindow.prototype.open = function (latlng, text) {
            if (this._window != null) this.close();

            this._text = text;
            this._position = latlng;

            this.setMap(this._map);
        };

        JM.TextWindow.prototype.close = function () {
            this.setMap(null);
        };

        JM.TextWindow.prototype.onAdd = function () {
            this._window = document.createElement('DIV');
            this._window.style.position = 'absolute';
            this._window.style.cursor = 'default';
            this._window.style.padding = '40px 20px 0px 20px';
            this._window.style.textAlign = 'center';
            this._window.style.fontFamily = 'Arial,sans-serif';
            this._window.style.fontWeight = 'bold';
            this._window.style.fontSize = '12px';
            this._window.style.width = '88px';
            this._window.style.height = '88px';
            this._window.style.background = 'url(' + JM.Utils.GetImageUrl('window.png') + ')';
            this._window.innerHTML = this._text;

            this.getPanes().floatPane.appendChild(this._window);
        };

        JM.TextWindow.prototype.draw = function () {
            var point = this.getProjection().fromLatLngToDivPixel(this._position);

            this._window.style.top = (parseInt(point.y) - 128) + 'px';
            this._window.style.left = (parseInt(point.x) - 110) + 'px';
        };

        JM.TextWindow.prototype.onRemove = function () {
            this._window.parentNode.removeChild(this._window);
            this._window = null;
        };

        // Other
        //////////////////////////////////
        JM.Utils = JM.Utils || {};

        JM.Utils.GetImageUrl = function (image) {
            return JM.ImagesBaseUrl + image;
        };

        JM.Utils.SetOpacity = function (obj, opacity /* 0 to 100 */ ) {
            obj.style.opacity = opacity / 100;
            obj.style.filter = 'alpha(opacity=' + opacity + ')';
        };

        // Map creation
        //////////////////////////////////
        google.maps.event.addDomListener(window, 'load', function () {
            var regionMap = new JM.RegionMap(document.getElementById('map-canvas'));
        });
    /* ]]> */
    </script>
</body>
</html>
