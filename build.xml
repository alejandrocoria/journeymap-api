<?xml version="1.0" encoding="UTF-8"?>
<project name="JourneyMap" basedir="." default="all">

    <!-- Update when new version is going to be released -->
    <property name="jmversion" value="3.2.0b2" />
    <property name="mcversion" value="1.6.4" />
    <property name="forgeversion" value="1.6.4-9.11.1.964" />

    <property name="unlimited" value="Unlimited" />
    <property name="fairplay" value="FairPlay" />

    <property name="java.dir" location="${basedir}/src/main/java" />
    <property name="resources.dir" location="${basedir}/src/main/resources" />
    <property name="dist.dir" location="${basedir}/dist" />
    <property name="forge.dir" location="${basedir}/../forge/mcp" />
    <property name="forge.build.dir" location="${forge.dir}/build" />
    <property name="forge.reobf.dir" location="${forge.dir}/reobf/minecraft" />
    <property name="forge.src.dir" location="${forge.dir}/src/minecraft" />

    <!-- Timestamp for build -->
    <tstamp>
        <format property="TODAY" pattern="yyyy-MM-dd.HHMM"/>
    </tstamp>

    <!-- Change if not on Windows, but don't check in the change. -->
    <!-- TODO:  OS detection -->
    <property name="python" location="${forge.dir}/runtime/bin/python/python_mcp.exe" />

    <target name="all" description="All" depends="init, build-unlimited, build-fairplay">
        <echo message="Done." />
    </target>

    <target name="build-unlimited" description="Build Unlimited Edition" depends="init">
        <stage edition="${unlimited}"/>
        <dist edition="${unlimited}"/>
        <ant target="cleanforge" />
    </target>

    <target name="build-fairplay" description="Build FairPlay Edition" depends="init">
        <stage edition="${fairplay}"/>
        <delete file="${forge.src.dir}/net/techbrew/journeymap/feature/impl/Unlimited.java" failonerror="true" />
        <delete file="${forge.build.dir}/net/techbrew/journeymap/feature/impl/Unlimited.class" failonerror="true"/>
        <dist edition="${fairplay}"/>
        <ant target="cleanforge" />
    </target>

    <target name="init">
        <echo message="Cleaning old build and dist, reobf" />
        <delete dir="${forge.build.dir}" />
        <delete dir="${dist.dir}" />
        <delete dir="${forge.reobf.dir}" />

        <echo message="Creating build and dist dirs" />
        <mkdir dir="${forge.build.dir}" />
        <mkdir dir="${dist.dir}" />
    </target>

    <target name="cleanforge">
        <delete dir="${forge.dir}/lib" />
        <delete dir="${forge.src.dir}/ar/com/hjg/pngj" />
        <delete dir="${forge.src.dir}/se/rupy/http" />
        <delete dir="${forge.src.dir}/net/techbrew" />
        <delete dir="${forge.src.dir}/assets/journeymap" />
        <delete file="${forge.src.dir}/assets/minecraft/pack.mcmeta" />
        <delete file="${forge.src.dir}/net/minecraft/client/renderer/entity/RenderFacade.java" />
    </target>

    <macrodef name="stage">
        <attribute name="edition"/>
        <sequential>

            <!-- Clean forge dirs -->
            <ant target="cleanforge" />

            <!-- Copy custom gradle build script -->
            <copy file="${basedir}/build.gradle" tofile="${forge.dir}/journeymap-build.gradle" failonerror="true" overwrite="true" />

            <!-- Copy Java libs -->
            <copy todir="${forge.dir}/lib" overwrite="true">
                <fileset dir="${basedir}/lib"  />
            </copy>

            <!-- Copy Java sources -->
            <copy todir="${forge.src.dir}" failonerror="true" overwrite="true">
                <fileset dir="${java.dir}" />
            </copy>

            <!-- Replace params in JourneyMap class -->
            <replace file="${forge.src.dir}/net/techbrew/journeymap/JourneyMap.java" token="@JMVERSION@" value="${jmversion}" />
            <replace file="${forge.src.dir}/net/techbrew/journeymap/JourneyMap.java" token="@MCVERSION@" value="${mcversion}" />

            <!-- Copy resources -->
            <copy todir="${forge.src.dir}" failonerror="true" overwrite="true">
                <fileset dir="${resources.dir}" />
            </copy>

            <!-- Replace tokens in resources -->
            <replace dir="${forge.src.dir}" token="@JMVERSION@" value="${jmversion}" />
            <replace dir="${forge.src.dir}" token="@FORGEVERSION@" value="${forgeversion}" />
            <replace dir="${forge.src.dir}" token="@MCVERSION@" value="${mcversion}" />
            <replace dir="${forge.src.dir}" token="@EDITION@" value="@{edition}" />
            <replace dir="${forge.src.dir}" token="@DATE@" value="${TODAY}" />

            <!-- Copy non-Java files to resources -->
            <copy todir="${forge.src.dir}" failonerror="true">
                <fileset dir="${java.dir}" excludes="**/*.java" />
            </copy>

            <!-- Minify js and css -->
            <ant target="minify" />

        </sequential>
    </macrodef>

    <macrodef name="dist">
        <attribute name="edition"/>
        <attribute name="jarfile" default="JourneyMap${jmversion}_@{edition}_MC${mcversion}.jar" />
        <sequential>

            <exec executable="${python}" dir="${forge.dir}">
                <arg value="runtime/recompile.py"/>
                <arg value="%*"/>
            </exec>

            <exec executable="${python}" dir="${forge.dir}">
                <arg value="runtime/reobfuscate.py"/>
                <arg value="%*"/>
            </exec>

            <jar destfile="${dist.dir}/@{jarfile}" duplicate="preserve" index="true" manifestencoding="UTF-8">
                <manifest>
                    <attribute name="Built-By" value="techbrew (Mark Woodman)"/>
                    <attribute name="Built-Date" value="${TODAY}"/>
                    <attribute name="Implementation-Vendor" value="journeymap.techbrew.net"/>
                    <attribute name="Implementation-Title" value="JourneyMap"/>
                    <attribute name="Implementation-Version" value="${jmversion} @{edition} Edition"/>
                </manifest>
                <fileset dir="${forge.build.dir}" />
            </jar>
            <echo message="Built: ${dist.dir}\@{jarfile}" />

            <fail message="@edition Dist Failed">
                <condition>
                    <not>
                        <available file="${dist.dir}/@{jarfile}" />
                    </not>
                </condition>
            </fail>

        </sequential>
    </macrodef>


    <target name="minify">
        <taskdef name="yuicompress" classname="com.yahoo.platform.yui.compressor.YUICompressTask">
            <classpath>
                <pathelement path="${basedir}/lib/yuicompressor-2.4.7.jar" />
                <pathelement path="${basedir}/lib/YUIAnt.jar" />
            </classpath>
        </taskdef>
        <yuicompress linebreak="16000" warn="false" munge="no" preserveallsemicolons="true"
                     outputfolder="${forge.src.dir}/assets/journeymap/web/js">
            <fileset dir="${resources.dir}/assets/journeymap/web/js" >
                <include name="journeymap.js" />
            </fileset>
        </yuicompress>
        <yuicompress linebreak="16000" warn="false" munge="no" preserveallsemicolons="true"
                     outputfolder="${forge.src.dir}/assets/journeymap/web/css">
            <fileset dir="${resources.dir}/assets/journeymap/web/css" >
                <include name="journeymap.css" />
            </fileset>
        </yuicompress>
    </target>


    <macrodef name="editionJarzip">
        <attribute name="edition"/>
        <attribute name="zipName"/>
        <sequential>

            <tstamp>
                <format property="TODAY" pattern="yyyy-MM-dd"/>
            </tstamp>

            <mkdir dir="${dist.dir}" />
            <delete file="${dist.dir}/@{zipName}.jar" />

            <copy todir="${build.dir}" failonerror="true" overwrite="true" file="${resources.dir}/mcmod.info" />
            <copy todir="${build.dir}" failonerror="true" overwrite="true" file="${resources.dir}/changelog.txt" />

            <replace dir="${build.dir}" token="@JMVERSION@" value="${jmversion}" />
            <replace dir="${build.dir}" token="@EDITION@" value="@{edition}" />
            <replace dir="${build.dir}" token="@MCVERSION@" value="${mcversion}" />
            <replace dir="${build.dir}" token="@DATE@" value="${TODAY}" />

            <jar destfile="${dist.dir}/@{zipName}.jar" duplicate="preserve" index="true" manifestencoding="UTF-8">
                <manifest>
                    <attribute name="Built-By" value="Mark Woodman"/>
                    <attribute name="Built-Date" value="${TODAY}"/>
                    <attribute name="Implementation-Vendor" value="TechBrew.net"/>
                    <attribute name="Implementation-Title" value="JourneyMap"/>
                    <attribute name="Implementation-Version" value="${jmversion} @{edition} Edition"/>
                </manifest>
                <fileset dir="${build.dir}" />
            </jar>
            <echo message="Built: ${dist.dir}\@{zipName}.jar" />

        </sequential>
    </macrodef>

</project>
